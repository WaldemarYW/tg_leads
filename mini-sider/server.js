import express from "express";
import cors from "cors";
import dotenv from "dotenv";

dotenv.config();

const app = express();
app.use(express.json({ limit: "1mb" }));
app.use(cors());
app.options(/.*/, cors());

const PORT = process.env.PORT || 3000;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const DEFAULT_MODEL = process.env.OPENAI_DIALOG_MODEL || "gpt-4o-mini-2024-07-18";

const HR_ASSISTANT_PROMPT = `Ð¢Ð¸ â€“ Ð²Ñ–Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¸Ð¹ HR-Ð°ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ñ–Ñ— Â«FuriozaÂ».
Ð¢Ð²Ð¾Ñ” Ð·Ð°Ð²Ð´Ð°Ð½Ð½Ñ â€“ Ð²ÐµÑÑ‚Ð¸ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ñ–Ð² Ð¿Ð¾ Ð²Ð¾Ñ€Ð¾Ð½Ñ†Ñ– Ð²Ñ–Ð´ Ð¿ÐµÑ€ÑˆÐ¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñƒ Ð´Ð¾ Ð·Ð°Ð¿Ð¾Ð²Ð½ÐµÐ½Ð½Ñ Ð°Ð½ÐºÐµÑ‚Ð¸.
ÐŸÑ€Ð°Ñ†ÑŽÐ¹ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¾ÑŽ Ð¼Ð¾Ð²Ð¾ÑŽ, Ð¿Ð¸ÑˆÐ¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ– Ð¿Ð¾-Ð»ÑŽÐ´ÑÑŒÐºÐ¸, Ð½Ñ–Ð±Ð¸ Ð¶Ð¸Ð²Ð¸Ð¹ HR Ñƒ Telegram.
Ð’ÐÐ–Ð›Ð˜Ð’Ðž: Ð½Ðµ Ð²Ð¸Ð³Ð°Ð´ÑƒÐ¹ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ, Ð½Ðµ Ð´Ð¾Ð´Ð°Ð²Ð°Ð¹ Ð½Ñ–Ñ‡Ð¾Ð³Ð¾ Ð¿Ð¾Ð·Ð° Ñ€Ð°Ð¼ÐºÐ°Ð¼Ð¸ ÑÑ†ÐµÐ½Ð°Ñ€Ñ–ÑŽ Ð½Ð¸Ð¶Ñ‡Ðµ.

Ð¡Ñ†ÐµÐ½Ð°Ñ€Ñ–Ð¹ (Ð´Ð¾Ð·Ð²Ð¾Ð»ÐµÐ½Ð° Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ):
1) ÐŸÑ€Ð¸Ð²Ñ–Ñ‚Ð°Ð½Ð½Ñ: Â«Ð”Ð¾Ð±Ñ€Ð¾Ð³Ð¾ Ð´Ð½Ñ ðŸ™‚ ... HR ÐºÐ¾Ð¼Ð¿Ð°Ð½Ñ–Ñ— Â«FuriozaÂ» ... Ð’Ð¸ Ð·Ð°Ð»Ð¸ÑˆÐ°Ð»Ð¸ Ð²Ñ–Ð´Ð³ÑƒÐº ... Ð¿Ð¾ÑˆÑƒÐº Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¸Ð¹?Â»
2) Ð—Ð°Ñ†Ñ–ÐºÐ°Ð²Ð»ÐµÐ½Ñ–ÑÑ‚ÑŒ: Â«Ð§ÑƒÐ´Ð¾Ð²Ð¾ ðŸ™Œ ... ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ñ€Ð¾Ð·Ð¿Ð¾Ð²Ñ–Ð¼ ... Ñ…Ð¾Ð»Ð´Ð¸Ð½Ð³Ð¾Ð²Ð° ÐºÐ¾Ð¼Ð¿Ð°Ð½Ñ–Ñ ... ÑÑ„ÐµÑ€Ð° Ð´ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ñƒ.Â»
3) Ð©Ð¾ Ñ‚Ð°ÐºÐµ Ð´ÐµÐ¹Ñ‚Ð¸Ð½Ð³ + Ð¾Ð±Ð¾Ð²Ê¼ÑÐ·ÐºÐ¸: Â«Ð¿Ð»Ð°Ñ‚Ð½Ðµ ÑÐ¿Ñ–Ð»ÐºÑƒÐ²Ð°Ð½Ð½Ñ Ð² Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¸Ñ… Ñ‡Ð°Ñ‚Ð°Ñ… ... Ð‘ÐµÐ· Ð´Ð·Ð²Ñ–Ð½ÐºÑ–Ð²/Ð²Ñ–Ð´ÐµÐ¾, Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ñ‚ÐµÐºÑÑ‚.Â» + Â«Ð²ÐµÑÑ‚Ð¸ Ñ‡Ð°Ñ‚Ð¸ ... Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ‚Ð¸ ... Ð¿Ñ€Ð°Ñ†ÑŽÐ²Ð°Ñ‚Ð¸ Ð· Ð»Ð¸ÑÑ‚Ð°Ð¼Ð¸/Ñ–Ð½Ð²Ð°Ð¹Ñ‚Ð°Ð¼Ð¸ ...Â».
   ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ: Â«Ð§Ð¸ Ð²ÑÐµ Ð·Ñ€Ð¾Ð·ÑƒÐ¼Ñ–Ð»Ð¾? ÐœÐ¾Ð¶Ð»Ð¸Ð²Ð¾, Ñ” Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ?Â»
4) Ð“Ñ€Ð°Ñ„Ñ–Ðº: Ð´ÐµÐ½Ð½Ð° 14:00â€“23:00, Ð½Ñ–Ñ‡Ð½Ð° 23:00â€“08:00; 8 Ð²Ð¸Ñ…Ñ–Ð´Ð½Ð¸Ñ… Ð½Ð° Ð¼Ñ–ÑÑÑ†ÑŒ, Ð±ÐµÑ€ÐµÑˆ ÐºÐ¾Ð»Ð¸ Ð·Ñ€ÑƒÑ‡Ð½Ð¾.
   ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ: Â«Ð¯ÐºÐ¸Ð¹ Ð³Ñ€Ð°Ñ„Ñ–Ðº Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ñ‚Ð¾Ð±Ñ– Ð¿Ñ–Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ?Â»
5) Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð±ÐµÐ· Ð²Ð¸Ð±Ð¾Ñ€Ñƒ: Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÑÑ”Ð¼Ð¾, Ñ‰Ð¾ Ð¿Ñ–Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð¼Ñ–Ð½Ñ–ÐºÑƒÑ€Ñ + Ð²Ñ–Ð´ÐµÐ¾ Ð´Ð»Ñ Ð½Ð¾Ð²Ð°Ñ‡ÐºÑ–Ð², Ñ– Ð¾Ð´Ñ€Ð°Ð·Ñƒ Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ñ”Ð¼Ð¾ Ð¾Ð±Ð¸Ð´Ð²Ð° Ð¼Ð°Ñ‚ÐµÑ€Ñ–Ð°Ð»Ð¸.
6) ÐÐ°Ð²Ñ‡Ð°Ð½Ð½Ñ: 3 Ð³Ð¾Ð´Ð¸Ð½Ð¸, Ð¾Ð½Ð»Ð°Ð¹Ð½, Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ– Ð±Ð»Ð¾ÐºÐ¸, Ð²Ñ–Ð´ÐµÐ¾ÑƒÑ€Ð¾ÐºÐ¸, Ñ‚ÐµÑÑ‚Ð¸, Ñƒ Ð·Ñ€ÑƒÑ‡Ð½Ð¾Ð¼Ñƒ Ñ‚ÐµÐ¼Ð¿Ñ–.
   ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ: Â«Ð§Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ñ– Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð´Ð¾ Ð½Ð°Ð²Ñ‡Ð°Ð½Ð½Ñ?Â»
7) ÐÐ½ÐºÐµÑ‚Ð°: Ð¿ÐµÑ€ÐµÐ»Ñ–Ðº 10 Ð¿ÑƒÐ½ÐºÑ‚Ñ–Ð² Ñ– Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ Ð²Ñ–ÐºÑƒ.

Ð”Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ñ– Ð´Ð¾Ð·Ð²Ð¾Ð»ÐµÐ½Ñ– Ð±Ð»Ð¾ÐºÐ¸ Ð´Ð»Ñ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÐµÐ¹ Ð½Ð° Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ (Ð¼Ð¾Ð¶Ð½Ð° Ñ‚Ñ€Ð¾Ñ…Ð¸ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ð½ÑƒÑ‚Ñ–ÑˆÐµ, Ð°Ð»Ðµ ÑÑ‚Ð¸ÑÐ»Ð¾):
1) Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸: Ð¿Ð¾Ð²Ð½Ñ–ÑÑ‚ÑŽ Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ñ–Ð¹Ð½Ð¾; 2 Ð·Ð¼Ñ–Ð½Ð¸ (Ð¾Ð±Ð¸Ñ€Ð°Ñ”Ñˆ Ð¾Ð´Ð½Ñƒ Ñ– Ð¿Ñ€Ð°Ñ†ÑŽÑ”Ñˆ Ð¿Ð¾ Ð½Ñ–Ð¹);
   1â€“2 Ð²Ð¸Ñ…Ñ–Ð´Ð½Ð¸Ñ… Ð½Ð° Ñ‚Ð¸Ð¶Ð´ÐµÐ½ÑŒ (1 Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¾Ð²Ð°Ð½Ð¾, 2-Ð¹ Ð·Ð° Ð±Ð°Ð¶Ð°Ð½Ð½ÑÐ¼; Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ñ–Ñ â€” 1 Ð²Ð¸Ñ…Ñ–Ð´Ð½Ð¸Ð¹);
   Ð¿ÐµÑ€ÐµÑ€Ð²Ð° ~1 Ð³Ð¾Ð´Ð¸Ð½Ð° Ð½Ð° Ð·Ð¼Ñ–Ð½Ñƒ (Ñ€Ð¾Ð·Ð¿Ð¾Ð´Ñ–Ð»ÑÑ”Ñˆ ÑÐ°Ð¼Ð¾ÑÑ‚Ñ–Ð¹Ð½Ð¾).
   Ð’Ð°Ð¶Ð»Ð¸Ð²Ð¾: Ð¿Ñ–ÑÐ»Ñ Ð²Ð¸Ð±Ð¾Ñ€Ñƒ Ð³Ñ€Ð°Ñ„Ñ–ÐºÐ° Ñ‚Ð¸ Ð·Ð°ÐºÑ€Ñ–Ð¿Ð»ÑŽÑ”ÑˆÑÑ Ð·Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾ÑŽ/Ð°Ð´Ð¼Ñ–Ð½Ñ–ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼/Ð°Ð½ÐºÐµÑ‚Ð°Ð¼Ð¸;
   Ð·Ð¼Ñ–Ð½Ð° Ð³Ñ€Ð°Ñ„Ñ–ÐºÐ° = Ð·Ð¼Ñ–Ð½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¸.
2) Ð¯Ðº Ð½Ð°Ñ€Ð°Ñ…Ð¾Ð²ÑƒÑ”Ñ‚ÑŒÑÑ Ð·Ð°Ñ€Ð¾Ð±Ñ–Ñ‚Ð¾Ðº: Ð¼Ð¾Ð½ÐµÑ‚Ð¸Ð·ÑƒÑ”Ñ‚ÑŒÑÑ Ð±ÑƒÐ´ÑŒ-ÑÐºÐ° Ð´Ñ–Ñ Ð½Ð° ÑÐ°Ð¹Ñ‚Ñ– (Ð²Ñ…Ñ–Ð´Ð½Ñ–/Ð²Ð¸Ñ…Ñ–Ð´Ð½Ñ– Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ,
   ÑÐºÑ‰Ð¾ Ð±ÑƒÐ»Ð° Ð²Ð·Ð°Ñ”Ð¼Ð¾Ð´Ñ–Ñ). Ð¯ÐºÑ‰Ð¾ Ð½Ð°Ð´Ñ–ÑÐ»Ð°Ð² Ð¿Ð¸ÑÑŒÐ¼Ð¾ Ñ– ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð½Ðµ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð², Ð°Ð»Ðµ Ð²Ñ–Ð´ÐºÑ€Ð¸Ð²/Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð² â€”
   Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð·Ð°Ñ€Ð°Ñ…Ð¾Ð²ÑƒÑ”Ñ‚ÑŒÑÑ.
3) Ð—Ð²Ñ–Ð´ÐºÐ¸ Ð³Ñ€Ð¾ÑˆÑ–: Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð° Ð½Ðµ Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ â€” Ð¿Ð»Ð°Ñ‚ÑÑ‚ÑŒ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ– (Ð¿Ñ–Ð´Ð¿Ð¸ÑÐºÐ¸, Ð¿Ð°ÐºÐµÑ‚Ð¸ Ñ‡Ð°Ñ‚Ñ–Ð²),
   Ð´Ð°Ð»Ñ– Ð³Ñ€Ð¾ÑˆÑ– Ñ€Ð¾Ð·Ð¿Ð¾Ð´Ñ–Ð»ÑÑŽÑ‚ÑŒÑÑ Ð¿Ð¾ Ð°Ð½ÐºÐµÑ‚Ð°Ñ….
4) Ð¢Ð°Ñ€Ð¸Ñ„Ð¸ Ð´Ñ–Ð¹: Ñ…Ð²Ð¸Ð»Ð¸Ð½Ð° Ñ‡Ð°Ñ‚Ñƒ â€” 0,12 $; Ð½Ð°Ð»Ñ–Ð¿ÐºÐ° â€” 0,11â€“0,33 $; Ñ„Ð¾Ñ‚Ð¾/Ð²Ñ–Ð´ÐµÐ¾ â€” 0,50 $ Ð°Ð±Ð¾ 2,80 $;
   Ð¿Ð¸ÑÑŒÐ¼Ð¾-Ñ€Ð¾Ð·Ð¿Ð¾Ð²Ñ–Ð´ÑŒ: Ñ‚Ð¸ Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ñ”Ñˆ â€” 0,60 $, Ñ‚Ð¾Ð±Ñ– Ð½Ð°Ð´ÑÐ¸Ð»Ð°ÑŽÑ‚ÑŒ â€” 1,80 $.
   Ð£ÑÐµ Ñ†Ðµ Ñ„Ð¾Ñ€Ð¼ÑƒÑ” Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð±Ð°Ð»Ð°Ð½Ñ.
5) Ð’Ñ–Ð´ÑÐ¾Ñ‚Ð¾Ðº Ð²Ð¸Ð¿Ð»Ð°Ñ‚: Ñƒ Ð¿ÐµÑ€ÑˆÐ¸Ð¹ Ð¼Ñ–ÑÑÑ†ÑŒ â€” 48% Ð²Ñ–Ð´ Ð±Ð°Ð»Ð°Ð½ÑÑƒ.
   ÐŸÐ¾Ð´Ð°Ð»ÑŒÑˆÑ– ÑƒÐ¼Ð¾Ð²Ð¸ Ñ‚Ð° Ð±Ð¾Ð½ÑƒÑÐ¸ Ð·Ð°Ð»ÐµÐ¶Ð°Ñ‚ÑŒ Ð²Ñ–Ð´ Ð²Ð½ÑƒÑ‚Ñ€Ñ–ÑˆÐ½Ñ–Ñ… Ð¿Ñ€Ð°Ð²Ð¸Ð» Ð¿Ñ€Ð¾Ñ”ÐºÑ‚Ñƒ.
6) Ð ÐµÐ°Ð»ÑŒÐ½Ñ– Ð·Ð°Ñ€Ð¾Ð±Ñ–Ñ‚ÐºÐ¸: 1-Ð¹ Ð¼Ñ–ÑÑÑ†ÑŒ ~400 $ (Ð½ÐµÑ€Ð¾Ð·ÐºÑ€ÑƒÑ‡ÐµÐ½Ñ– Ð°Ð½ÐºÐµÑ‚Ð¸, Ð¼Ð°Ð»Ð¾ Ð¿Ð¾ÑÑ‚Ñ–Ð¹Ð½Ð¸ÐºÑ–Ð²/Ð¿Ð¾Ð´Ð°Ñ€ÑƒÐ½ÐºÑ–Ð²),
   2-Ð¹ Ð¼Ñ–ÑÑÑ†ÑŒ 700â€“800 $, 4-Ð¹ Ð¼Ñ–ÑÑÑ†ÑŒ Ð²Ñ–Ð´ 1000 $ ÑÑ‚Ð°Ð±Ñ–Ð»ÑŒÐ½Ð¾ (Ñ–Ð½ÐºÐ¾Ð»Ð¸ Ð· 2-Ð³Ð¾).
   ÐžÑÐ½Ð¾Ð²Ð½Ñ– Ð²ÐµÐ»Ð¸ÐºÑ– ÑÑƒÐ¼Ð¸ â€” Ð· Ð¿Ð¾Ð´Ð°Ñ€ÑƒÐ½ÐºÑ–Ð².
7) Ð ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð°: Ð¿Ñ€Ð¸Ð²Ñ–Ð² Ð»ÑŽÐ´Ð¸Ð½Ñƒ â€” Ð²Ð¾Ð½Ð° Ð·Ð°Ñ€Ð¾Ð±Ð»ÑÑ” 200 $, Ñ‚Ð¸ Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÑ”Ñˆ 100 $ Ð±Ð¾Ð½ÑƒÑÑƒ.
8) Ð’Ð¸Ð¿Ð»Ð°Ñ‚Ð¸: Ð¾ÑÐ½Ð¾Ð²Ð½Ñ– Ð· 8 Ð¿Ð¾ 15 Ñ‡Ð¸ÑÐ»Ð¾; Ð°Ð²Ð°Ð½Ñ Ñ‰Ð¾Ñ‚Ð¸Ð¶Ð½Ñ Ð´Ð¾ 20% Ð²Ñ–Ð´ Ñ‚Ð¾Ñ‚Ð°Ð»Ñƒ.
9) ÐÐ°Ð²Ñ‡Ð°Ð½Ð½Ñ: Ð¿Ð¾Ñ‡Ð¸Ð½Ð°Ñ”Ñ‚ÑŒÑÑ Ð¿Ñ–ÑÐ»Ñ ÑÐ¿Ñ–Ð²Ð±ÐµÑÑ–Ð´Ð¸, Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¾Ð½Ð»Ð°Ð¹Ð½, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ” Ñ‚ÐµÐ¾Ñ€Ñ–ÑŽ Ñ‚Ð° Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ– Ð·Ð°Ð²Ð´Ð°Ð½Ð½Ñ.
   ÐÐ°Ð²Ñ‡Ð°Ð½Ð½Ñ Ð±ÐµÐ·ÐºÐ¾ÑˆÑ‚Ð¾Ð²Ð½Ðµ.
10) Ð¡Ñ‚Ð°Ð¶ÑƒÐ²Ð°Ð½Ð½Ñ: Ð°Ð´Ð°Ð¿Ñ‚Ð°Ñ†Ñ–Ð¹Ð½Ð¸Ð¹ Ð¿ÐµÑ€Ñ–Ð¾Ð´, Ð¾Ð¿Ð»Ð°Ñ‚Ð° ÑÐº Ñƒ Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ñ–Ð¹ Ñ€Ð¾Ð±Ð¾Ñ‚Ñ–;
   Ð¼Ð¾Ð¶Ð½Ð° Ð·Ð¼Ñ–Ð½Ð¸Ñ‚Ð¸ Ð³Ñ€Ð°Ñ„Ñ–Ðº/Ð°Ð´Ð¼Ñ–Ð½Ñ–ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°/ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ. ÐœÐ¾Ð¶Ð½Ð° Ð¾Ð´Ñ€Ð°Ð·Ñƒ Ð·Ð°Ñ€Ð¾Ð±Ð»ÑÑ‚Ð¸.
11) ÐšÐ»ÑŽÑ‡Ð¾Ð²Ð¸Ð¹ Ð¼ÐµÑÐµÐ´Ð¶: Ð½Ð°Ð²Ñ‡Ð°Ð½Ð½Ñ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐµ, Ð²Ð¸Ñ…Ñ–Ð´ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ– Ð³Ñ€Ð¾ÑˆÑ– ÑˆÐ²Ð¸Ð´ÐºÐ¸Ð¹, ÑƒÑÐµ Ð¿Ñ€Ð¾Ð·Ð¾Ñ€Ð¾,
    Ð·Ð°Ñ€Ð¾Ð±Ñ–Ñ‚Ð¾Ðº Ð·Ð°Ð»ÐµÐ¶Ð¸Ñ‚ÑŒ Ð²Ñ–Ð´ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ñ– Ñ‚Ð° Ð½Ð°Ð²Ð¸Ñ‡Ð¾Ðº.

ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°:
1) Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÑÑ‚Ð¸ÑÐ»Ð¾, Ð±ÐµÐ· Ð²Ð¾Ð´Ð¸; ÐºÑ–Ð»ÑŒÐºÐ° ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ñ… Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½ÑŒ ÐºÑ€Ð°Ñ‰Ðµ Ð´Ð¾Ð²Ð³Ð¸Ñ….
2) Ð¢Ð¾Ð½ Ð´Ð¾Ð±Ñ€Ð¾Ð·Ð¸Ñ‡Ð»Ð¸Ð²Ð¸Ð¹, Ñ‚ÐµÐ¿Ð»Ñ–ÑˆÐ¸Ð¹, Ð»ÑŽÐ´ÑÐ½Ð¸Ð¹; ÑƒÐ½Ð¸ÐºÐ°Ð¹ ÐºÐ°Ð½Ñ†ÐµÐ»ÑÑ€Ð¸Ñ‚Ñƒ. Ð”Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ð¾ 1â€“2 Ð´Ð¾Ñ€ÐµÑ‡Ð½Ñ– ÐµÐ¼Ð¾Ð´Ð·Ñ–.
2.1) ÐÐµ Ð·Ð²ÐµÑ€Ñ‚Ð°Ð¹ÑÑ Ð½Ð° Ñ–Ð¼'Ñ Ñ‚Ð° Ð½Ðµ Ð·Ð³Ð°Ð´ÑƒÐ¹ Ñ–Ð½ÑˆÐ¸Ñ… ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ñ–Ð²/Ñ‡Ð°Ñ‚Ñ–Ð² â€” Ð·Ð²ÐµÑ€Ñ‚Ð°Ð½Ð½Ñ Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ–.
2.2) Ð£Ð½Ð¸ÐºÐ°Ð¹ Ñ‡Ð°ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÐµÐ½Ð½Ñ ÑÐ»Ð¾Ð²Ð° Â«Ð´ÑÐºÑƒÑŽÂ» â€” Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ Ð¹Ð¾Ð³Ð¾ Ð»Ð¸ÑˆÐµ Ð·Ð° Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸.
3) Ð¯ÐºÑ‰Ð¾ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚ ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ â€” Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÑƒ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ñƒ Ð¼ÐµÐ¶Ð°Ñ… Ð´Ð¾Ð·Ð²Ð¾Ð»ÐµÐ½Ð¸Ñ… Ð±Ð»Ð¾ÐºÑ–Ð²
   Ñ– Ð¼Ê¼ÑÐºÐ¾ Ð¿Ð¾Ð²ÐµÑ€Ñ‚Ð°Ð¹ Ð´Ð¾ Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ð¾Ð³Ð¾ ÐºÑ€Ð¾ÐºÑƒ ÑÑ†ÐµÐ½Ð°Ñ€Ñ–ÑŽ.
4) Ð¯ÐºÑ‰Ð¾ Ñ” Â«Ñ‡ÐµÑ€Ð½ÐµÑ‚ÐºÐ° HRÂ», Ñ—Ñ— Ð¼Ð¾Ð¶Ð½Ð° Ð¿ÐµÑ€ÐµÑ„Ñ€Ð°Ð·ÑƒÐ²Ð°Ñ‚Ð¸, Ð°Ð»Ðµ Ð·Ð¼Ñ–ÑÑ‚ Ð¼Ð°Ñ” Ð»Ð¸ÑˆÐ°Ñ‚Ð¸ÑÑ Ð² Ð¼ÐµÐ¶Ð°Ñ… ÑÑ†ÐµÐ½Ð°Ñ€Ñ–ÑŽ.
5) ÐÐµ Ð´Ð¾Ð´Ð°Ð²Ð°Ð¹ Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ, ÑÐºÑ‰Ð¾ Ñ—Ñ… Ð½ÐµÐ¼Ð°Ñ” Ñƒ Ñ‡ÐµÑ€Ð½ÐµÑ‚Ñ†Ñ– HR.
6) Ð¯ÐºÑ‰Ð¾ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚ Ð²Ñ–Ð´Ð¼Ð¾Ð²Ð»ÑÑ”Ñ‚ÑŒÑÑ Ð°Ð±Ð¾ ÐºÐ°Ð¶Ðµ, Ñ‰Ð¾ Ð¹Ð¾Ð¼Ñƒ Ð½Ðµ Ð¿Ñ–Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ, Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð±ÐµÐ· Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ð½ÑŒ.`;

const STOP_CLASSIFY_PROMPT = `Ð¢Ð¸ ÐºÐ»Ð°ÑÐ¸Ñ„Ñ–ÐºÐ°Ñ‚Ð¾Ñ€. Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ð¾Ð´Ð½Ð¸Ð¼ ÑÐ»Ð¾Ð²Ð¾Ð¼: STOP Ð°Ð±Ð¾ CONTINUE.
STOP ÑÐºÑ‰Ð¾ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚ Ð²Ñ–Ð´Ð¼Ð¾Ð²Ð»ÑÑ”Ñ‚ÑŒÑÑ, ÐºÐ°Ð¶Ðµ Ñ‰Ð¾ Ð½Ðµ Ð¿Ñ–Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ/Ð½Ðµ Ñ†Ñ–ÐºÐ°Ð²Ð¾/Ð½Ðµ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾, Ð²Ð¶Ðµ Ð·Ð½Ð°Ð¹ÑˆÐ¾Ð² Ñ€Ð¾Ð±Ð¾Ñ‚Ñƒ,
Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð½Ðµ Ð¿Ð¸ÑÐ°Ñ‚Ð¸, Ñ…Ð¾Ñ‡Ðµ Ð·ÑƒÐ¿Ð¸Ð½Ð¸Ñ‚Ð¸ ÑÐ¿Ñ–Ð»ÐºÑƒÐ²Ð°Ð½Ð½Ñ, Ð°Ð±Ð¾ Ñ‡Ñ–Ñ‚ÐºÐ¾ Ð½Ðµ Ñ…Ð¾Ñ‡Ðµ Ð¿Ñ€Ð¾Ð´Ð¾Ð²Ð¶ÑƒÐ²Ð°Ñ‚Ð¸.
CONTINUE ÑÐºÑ‰Ð¾ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚ Ð·Ð°Ñ†Ñ–ÐºÐ°Ð²Ð»ÐµÐ½Ð¸Ð¹, ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ, Ð°Ð±Ð¾ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ðµ.
ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÑ– Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ñ‚Ð¸Ð¿Ñƒ "Ð½ÐµÐ¼Ð°", "Ð¾Ðº", "Ð·Ñ€Ð¾Ð·ÑƒÐ¼Ñ–Ð»Ð¾", "ÑÑÐ½Ð¾", "Ð¿Ð¸Ñ‚Ð°Ð½ÑŒ Ð½ÐµÐ¼Ð°" Ñ‚Ñ€Ð°ÐºÑ‚ÑƒÐ¹ ÑÐº CONTINUE, Ð½Ðµ STOP.
ÐœÐ¾Ð²Ð¸: ÑƒÐºÑ€/Ñ€ÑƒÑ/Ð°Ð½Ð³Ð». ÐÑ–ÑÐºÐ¸Ñ… Ð¿Ð¾ÑÑÐ½ÐµÐ½ÑŒ.`;

const FORMAT_CHOICE_PROMPT = `Ð¢Ð¸ ÐºÐ»Ð°ÑÐ¸Ñ„Ñ–ÐºÐ°Ñ‚Ð¾Ñ€ Ð²Ð¸Ð±Ð¾Ñ€Ñƒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñƒ.
Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ð¾Ð´Ð½Ð¸Ð¼ ÑÐ»Ð¾Ð²Ð¾Ð¼: VIDEO, MINI_COURSE, BOTH Ð°Ð±Ð¾ UNKNOWN.

ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°:
- VIDEO: ÑÐºÑ‰Ð¾ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚ Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð²Ñ–Ð´ÐµÐ¾.
- MINI_COURSE: ÑÐºÑ‰Ð¾ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚ Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¼Ñ–Ð½Ñ–ÐºÑƒÑ€Ñ/ÐºÑƒÑ€Ñ/Ñ‚Ñ€ÐµÐ½Ð°Ð¶ÐµÑ€/ÑÐ°Ð¹Ñ‚.
- BOTH: ÑÐºÑ‰Ð¾ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚ Ñ…Ð¾Ñ‡Ðµ Ñ– Ð²Ñ–Ð´ÐµÐ¾, Ñ– Ð¼Ñ–Ð½Ñ–ÐºÑƒÑ€Ñ.
- UNKNOWN: ÑÐºÑ‰Ð¾ Ð½ÐµÐ¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ Ð½Ð°Ð´Ñ–Ð¹Ð½Ð¾ Ð²Ð¸Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸.

ÐœÐ¾Ð²Ð¸: ÑƒÐºÑ€/Ñ€ÑƒÑ/Ð°Ð½Ð³Ð». Ð‘ÐµÐ· Ð¿Ð¾ÑÑÐ½ÐµÐ½ÑŒ.`;

const INTENT_CLASSIFY_PROMPT = `Ð¢Ð¸ ÐºÐ»Ð°ÑÐ¸Ñ„Ñ–ÐºÐ°Ñ‚Ð¾Ñ€ Ð½Ð°Ð¼Ñ–Ñ€Ñƒ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð°.
Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ð¾Ð´Ð½Ð¸Ð¼ ÑÐ»Ð¾Ð²Ð¾Ð¼: QUESTION, ACK_CONTINUE, STOP Ð°Ð±Ð¾ OTHER.

ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°:
- QUESTION: ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚ ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ (Ð½Ð°Ð²Ñ–Ñ‚ÑŒ Ð±ÐµÐ· Ð·Ð½Ð°ÐºÐ° "?").
- ACK_CONTINUE: ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐµ Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ/Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð° Ð·Ð³Ð¾Ð´Ð° Ð½Ð° Ð¿Ñ€Ð¾Ð´Ð¾Ð²Ð¶ÐµÐ½Ð½Ñ ("Ð½ÐµÐ¼Ð°", "Ð¾Ðº", "Ð·Ñ€Ð¾Ð·ÑƒÐ¼Ñ–Ð»Ð¾", "ÑÑÐ½Ð¾", "Ñ‚Ð°Ðº", "Ð°Ð³Ð°", "Ð¿Ð¸Ñ‚Ð°Ð½ÑŒ Ð½ÐµÐ¼Ð°" Ñ‚Ð¾Ñ‰Ð¾).
- STOP: Ñ‡Ñ–Ñ‚ÐºÐ° Ð²Ñ–Ð´Ð¼Ð¾Ð²Ð°, Ð½ÐµÐ°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾, Ð¿Ñ€Ð¾Ñ…Ð°Ð½Ð½Ñ Ð½Ðµ Ð¿Ð¸ÑÐ°Ñ‚Ð¸, Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ð¸ Ð´Ñ–Ð°Ð»Ð¾Ð³.
- OTHER: ÑÐºÑ‰Ð¾ Ð½Ðµ Ð¼Ð¾Ð¶Ð½Ð° Ð½Ð°Ð´Ñ–Ð¹Ð½Ð¾ Ð²Ñ–Ð´Ð½ÐµÑÑ‚Ð¸ Ð´Ð¾ Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½Ñ–Ñ… ÐºÐ»Ð°ÑÑ–Ð².

ÐœÐ¾Ð²Ð¸: ÑƒÐºÑ€/Ñ€ÑƒÑ/Ð°Ð½Ð³Ð». Ð‘ÐµÐ· Ð¿Ð¾ÑÑÐ½ÐµÐ½ÑŒ.`;

app.get("/health", (_, res) => res.json({ ok: true, env: Boolean(OPENAI_API_KEY) }));

async function callOpenAI({ model = DEFAULT_MODEL, system, user, temperature }) {
  if (!OPENAI_API_KEY) {
    throw new Error("OPENAI_API_KEY is missing on server");
  }
  const response = await fetch("https://api.openai.com/v1/responses", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${OPENAI_API_KEY}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model,
      ...(typeof temperature === "number" ? { temperature } : {}),
      input: [
        { role: "system", content: system },
        { role: "user", content: user },
      ],
    }),
  });
  const bodyText = await response.text();
  let data;
  try {
    data = bodyText ? JSON.parse(bodyText) : {};
  } catch (err) {
    throw new Error(`OpenAI returned invalid JSON: ${bodyText.slice(0, 500)}`);
  }
  if (!response.ok) {
    const errorText = data?.error?.message || bodyText;
    throw new Error(`OpenAI ${response.status}: ${errorText}`);
  }
  const textOut = data?.output?.[0]?.content?.[0]?.text || data?.output_text || "";
  return { text: textOut, raw: data };
}

function buildHistoryPrompt(history = [], draft = "", forbidQuestions = false, combinedAnswerClarify = false) {
  const normalized = history
    .slice(-10)
    .map((item) => {
      const sender = item?.sender === "me" ? "Ð¯" : "ÐšÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚";
      const text = (item?.text || "").trim().replace(/\s+/g, " ");
      return `${sender}: ${text}`;
    })
    .join("\n");
  const draftBlock = draft ? `\nÐ§ÐµÑ€Ð½ÐµÑ‚ÐºÐ° HR (Ð¼Ð¾Ð¶Ð½Ð° Ð¿ÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»ÑŽÐ²Ð°Ñ‚Ð¸): ${draft}` : "";
  const forbidBlock = forbidQuestions ? "\nÐ’ÐÐ–Ð›Ð˜Ð’Ðž: Ð½Ðµ ÑÑ‚Ð°Ð² Ð¶Ð¾Ð´Ð½Ð¸Ñ… Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ð½ÑŒ Ñ– Ð½Ðµ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ '?'.\n" : "";
  const combinedBlock = combinedAnswerClarify
    ? "\nÐ’ÐÐ–Ð›Ð˜Ð’Ðž: ÑÑ„Ð¾Ñ€Ð¼ÑƒÐ¹ ÐžÐ”ÐÐ• Ñ†Ñ–Ð»Ñ–ÑÐ½Ðµ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ: ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ° Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ð¿Ð¾ ÑÑƒÑ‚Ñ– + ÐžÐ”ÐÐ• Ð¼'ÑÐºÐµ ÑƒÑ‚Ð¾Ñ‡Ð½ÑŽÑŽÑ‡Ðµ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ð² ÐºÑ–Ð½Ñ†Ñ–. ÐÐµ Ñ€Ð¾Ð·Ð±Ð¸Ð²Ð°Ð¹ Ð½Ð° Ð´Ð²Ð° Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ.\n"
    : "";
  return `${HR_ASSISTANT_PROMPT}${forbidBlock}${combinedBlock}\nÐžÑÑ‚Ð°Ð½Ð½Ñ– Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ (Ð²Ñ–Ð´ ÑÑ‚Ð°Ñ€Ð¸Ñ… Ð´Ð¾ Ð½Ð¾Ð²Ð¸Ñ…):\n${normalized || "(Ñ–ÑÑ‚Ð¾Ñ€Ñ–Ñ Ð¿ÑƒÑÑ‚Ð°)"}${draftBlock}\n\nÐ¡Ñ„Ð¾Ñ€Ð¼ÑƒÐ¹ ÐžÐ”ÐÐ£ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÑƒ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ð±ÐµÐ· Ð½ÑƒÐ¼ÐµÑ€Ð°Ñ†Ñ–Ñ— Ñ– Ð±ÐµÐ· Ð¿Ð¾ÑÑÐ½ÐµÐ½ÑŒ (Ð´Ð¾ 3 ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ñ… Ñ€ÐµÑ‡ÐµÐ½ÑŒ).`;
}

function buildStopPrompt(history = [], lastMessage = "") {
  const normalized = history
    .slice(-10)
    .map((item) => {
      const sender = item?.sender === "me" ? "Ð¯" : "ÐšÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚";
      const text = (item?.text || "").trim().replace(/\s+/g, " ");
      return `${sender}: ${text}`;
    })
    .join("\n");
  const lastLine = lastMessage ? `ÐžÑÑ‚Ð°Ð½Ð½Ñ” Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð°: ${lastMessage}` : "";
  return `${STOP_CLASSIFY_PROMPT}\n\nÐ†ÑÑ‚Ð¾Ñ€Ñ–Ñ:\n${normalized || "(Ð¿Ð¾Ñ€Ð¾Ð¶Ð½ÑŒÐ¾)"}\n${lastLine}`;
}

function buildFormatChoicePrompt(history = [], lastMessage = "") {
  const normalized = history
    .slice(-10)
    .map((item) => {
      const sender = item?.sender === "me" ? "Ð¯" : "ÐšÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚";
      const text = (item?.text || "").trim().replace(/\s+/g, " ");
      return `${sender}: ${text}`;
    })
    .join("\n");
  const lastLine = lastMessage ? `ÐžÑÑ‚Ð°Ð½Ð½Ñ” Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð°: ${lastMessage}` : "";
  return `${FORMAT_CHOICE_PROMPT}\n\nÐ†ÑÑ‚Ð¾Ñ€Ñ–Ñ:\n${normalized || "(Ð¿Ð¾Ñ€Ð¾Ð¶Ð½ÑŒÐ¾)"}\n${lastLine}`;
}

function buildIntentPrompt(history = [], lastMessage = "") {
  const normalized = history
    .slice(-10)
    .map((item) => {
      const sender = item?.sender === "me" ? "Ð¯" : "ÐšÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚";
      const text = (item?.text || "").trim().replace(/\s+/g, " ");
      return `${sender}: ${text}`;
    })
    .join("\n");
  const lastLine = lastMessage ? `ÐžÑÑ‚Ð°Ð½Ð½Ñ” Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð°: ${lastMessage}` : "";
  return `${INTENT_CLASSIFY_PROMPT}\n\nÐ†ÑÑ‚Ð¾Ñ€Ñ–Ñ:\n${normalized || "(Ð¿Ð¾Ñ€Ð¾Ð¶Ð½ÑŒÐ¾)"}\n${lastLine}`;
}

app.post("/dialog_suggest", async (req, res) => {
  try {
    const { history = [], draft = "", no_questions = false, combined_answer_clarify = false } = req.body || {};
    const prompt = buildHistoryPrompt(history, draft, Boolean(no_questions), Boolean(combined_answer_clarify));
    const { text, raw } = await callOpenAI({ system: "Ð¢Ð¸ â€” HR Furioza. Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾.", user: prompt });
    return res.json({ ok: true, text: (text || "").trim(), raw });
  } catch (error) {
    console.error("/dialog_suggest error", error);
    return res.status(500).json({ ok: false, error: error.message });
  }
});

app.post("/should_pause", async (req, res) => {
  try {
    const { history = [], last_message = "" } = req.body || {};
    const prompt = buildStopPrompt(history, last_message);
    const { text } = await callOpenAI({
      system: "You are a strict classifier.",
      user: prompt,
      temperature: 0,
    });
    const normalized = (text || "").trim().toLowerCase();
    const stop = normalized.startsWith("stop");
    return res.json({ ok: true, stop, text: (text || "").trim() });
  } catch (error) {
    console.error("/should_pause error", error);
    return res.status(500).json({ ok: false, error: error.message });
  }
});

app.post("/format_choice", async (req, res) => {
  try {
    const { history = [], last_message = "" } = req.body || {};
    const prompt = buildFormatChoicePrompt(history, last_message);
    const { text } = await callOpenAI({
      system: "You are a strict format classifier.",
      user: prompt,
      temperature: 0,
    });
    const normalized = (text || "").trim().toLowerCase();
    let choice = "unknown";
    if (normalized.startsWith("both")) {
      choice = "both";
    } else if (normalized.startsWith("mini_course") || normalized.startsWith("mini")) {
      choice = "mini_course";
    } else if (normalized.startsWith("video")) {
      choice = "video";
    }
    return res.json({ ok: true, choice, text: (text || "").trim() });
  } catch (error) {
    console.error("/format_choice error", error);
    return res.status(500).json({ ok: false, error: error.message });
  }
});

app.post("/intent_classify", async (req, res) => {
  try {
    const { history = [], last_message = "" } = req.body || {};
    const prompt = buildIntentPrompt(history, last_message);
    const { text } = await callOpenAI({
      system: "You are a strict intent classifier.",
      user: prompt,
      temperature: 0,
    });
    const normalized = (text || "").trim().toLowerCase();
    let intent = "other";
    if (normalized.startsWith("question")) {
      intent = "question";
    } else if (normalized.startsWith("ack_continue") || normalized.startsWith("ack")) {
      intent = "ack_continue";
    } else if (normalized.startsWith("stop")) {
      intent = "stop";
    }
    return res.json({ ok: true, intent, text: (text || "").trim() });
  } catch (error) {
    console.error("/intent_classify error", error);
    return res.status(500).json({ ok: false, error: error.message });
  }
});

app.use((err, req, res, next) => {
  console.error("Unhandled error:", err);
  if (res.headersSent) return next(err);
  res.status(500).json({ ok: false, error: err?.message || "Internal Server Error" });
});

app.listen(PORT, () => console.log(`AI server on :${PORT}`));
